<section class="section admin-catalogs">
  <div class="container">
    <h1>Catálogos</h1>

    <div class="tabs">
      <button class="tab" [class.active]="current()==='pais'" (click)="setType('pais')">Países</button>
      <button class="tab" [class.active]="current()==='provincia'" (click)="setType('provincia')">Provincias</button>
      <button class="tab" [class.active]="current()==='canton'" (click)="setType('canton')">Cantones</button>
      <button class="tab" [class.active]="current()==='distrito'" (click)="setType('distrito')">Distritos</button>
      <button class="tab" [class.active]="current()==='idtype'" (click)="setType('idtype')">Tipos de ID</button>
      <div class="spacer"></div>
      <button class="btn" (click)="openNew()">Nuevo</button>
    </div>

    <div class="card list" [attr.aria-busy]="loading()">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th *ngIf="current()==='idtype'">Descripción</th>
            <th *ngIf="current()==='provincia'">País</th>
            <th *ngIf="current()==='canton'">Provincia</th>
            <th *ngIf="current()==='canton'">País</th>
            <th *ngIf="current()==='distrito'">Cantón</th>
            <th *ngIf="current()==='distrito'">Provincia</th>
            <th *ngIf="current()==='distrito'">País</th>
            <th style="width:140px"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let it of displayItems()">
            <td>{{ it.name }}</td>
            <td *ngIf="current()==='idtype'">{{ $any(it).description }}</td>
            <td *ngIf="current()==='provincia'">{{ it.paisLabel || '—' }}</td>
            <td *ngIf="current()==='canton'">{{ it.provinciaLabel || '—' }}</td>
            <td *ngIf="current()==='canton'">{{ it.paisLabel || '—' }}</td>
            <td *ngIf="current()==='distrito'">{{ it.cantonLabel || '—' }}</td>
            <td *ngIf="current()==='distrito'">{{ it.provinciaLabel || '—' }}</td>
            <td *ngIf="current()==='distrito'">{{ it.paisLabel || '—' }}</td>
            <td class="actions">
              <button class="btn-ghost sm" (click)="openEdit(it)">Editar</button>
              <button class="btn-ghost sm" (click)="del(it)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="pager">
        <button class="btn-ghost" (click)="prev()" [disabled]="offset()===0 || loading()">← Anterior</button>
        <span class="muted">
          Mostrando {{ offset() + 1 }} – {{ offset() + (displayItems().length || 0) }}
          <ng-container *ngIf="total() as t"> de {{ t }}</ng-container>
        </span>
        <button class="btn-ghost" (click)="next()" [disabled]="!hasMore() || loading()">Siguiente →</button>
      </div>
      <p class="muted" *ngIf="!loading() && (displayItems()||[]).length===0">Sin registros.</p>
      <p class="error" *ngIf="error()">{{ error() }}</p>
    </div>

    <!-- Modal -->
    <div class="modal" *ngIf="modalOpen()" role="dialog" aria-modal="true">
      <div class="overlay" (click)="closeModal()"></div>
      <div class="dialog card">
        <h2>{{ isEdit() ? 'Editar' : 'Nuevo' }} {{ current() | titlecase }}</h2>
        <form [formGroup]="form" (ngSubmit)="save()" autocomplete="off">
          <label>
            <span>Nombre</span>
            <input formControlName="name" required />
          </label>

          <!-- Jerarquías -->
          <ng-container [ngSwitch]="current()">
            <ng-container *ngSwitchCase="'provincia'">
              <label>
                <span>País</span>
                <select formControlName="id_pais">
                  <option [ngValue]="undefined">Selecciona…</option>
                  <option *ngFor="let o of paises" [ngValue]="o.id">{{ o.label }}</option>
                </select>
              </label>
            </ng-container>

            <ng-container *ngSwitchCase="'canton'">
              <div class="grid2">
                <label>
                  <span>País</span>
                  <select formControlName="id_pais">
                    <option [ngValue]="undefined">Selecciona…</option>
                    <option *ngFor="let o of paises" [ngValue]="o.id">{{ o.label }}</option>
                  </select>
                </label>
                <label>
                  <span>Provincia</span>
                  <select formControlName="id_provincia">
                    <option [ngValue]="undefined">Selecciona…</option>
                    <option *ngFor="let o of provincias" [ngValue]="o.id">{{ o.label }}</option>
                  </select>
                </label>
              </div>
            </ng-container>

            <ng-container *ngSwitchCase="'distrito'">
              <div class="grid3">
                <label>
                  <span>País</span>
                  <select formControlName="id_pais">
                    <option [ngValue]="undefined">Selecciona…</option>
                    <option *ngFor="let o of paises" [ngValue]="o.id">{{ o.label }}</option>
                  </select>
                </label>
                <label>
                  <span>Provincia</span>
                  <select formControlName="id_provincia">
                    <option [ngValue]="undefined">Selecciona…</option>
                    <option *ngFor="let o of provincias" [ngValue]="o.id">{{ o.label }}</option>
                  </select>
                </label>
                <label>
                  <span>Cantón</span>
                  <select formControlName="id_canton">
                    <option [ngValue]="undefined">Selecciona…</option>
                    <option *ngFor="let o of cantones" [ngValue]="o.id">{{ o.label }}</option>
                  </select>
                </label>
              </div>
            </ng-container>

            <ng-container *ngSwitchCase="'idtype'">
              <label>
                <span>Descripción</span>
                <input formControlName="description" />
              </label>
            </ng-container>
          </ng-container>

          <div class="actions">
            <button class="btn" type="submit" [disabled]="form.invalid">Guardar</button>
            <button class="btn-ghost" type="button" (click)="closeModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

  </div>
</section>
